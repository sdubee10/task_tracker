<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>신청서 작성 - TaskFlow</title>
    <link rel="icon" href="data:,">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/request-form.css">
</head>
<body class="request-form-page">
    <div class="request-app">
        <!-- 헤더 -->
        <header class="request-header">
            <div class="header-left">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <path d="M3 9h18"/>
                        <path d="M9 21V9"/>
                    </svg>
                </div>
                <span class="logo-text">신청서 작성</span>
            </div>
            <div class="header-right">
                <div class="user-info" id="userInfo">
                    <span class="user-name"></span>
                    <span class="user-team"></span>
                </div>
            </div>
        </header>

        <!-- 메인 컨텐츠 -->
        <main class="request-main">
            <!-- 단계 표시 -->
            <div class="step-indicator">
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <span class="step-label">템플릿 선택</span>
                </div>
                <div class="step-line"></div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <span class="step-label">신청서 작성</span>
                </div>
                <div class="step-line"></div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <span class="step-label">검토 및 제출</span>
                </div>
            </div>

            <!-- Step 1: 템플릿 선택 -->
            <section class="step-content active" id="step1Content">
                <div class="step-header">
                    <h1>📋 신청서 템플릿 선택</h1>
                    <p>작성하려는 신청서 유형을 선택해주세요</p>
                </div>

                <!-- 검색 및 필터 -->
                <div class="template-filters">
                    <div class="search-box">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="M21 21l-4.35-4.35"/>
                        </svg>
                        <input type="text" id="templateSearch" placeholder="템플릿 검색...">
                    </div>
                    <div class="category-tabs" id="categoryTabs">
                        <button class="category-tab active" data-category="all">전체</button>
                        <button class="category-tab" data-category="custom">✨ 내 템플릿</button>
                        <button class="category-tab" data-category="DBA">🗄️ DBA</button>
                        <button class="category-tab" data-category="Frontend">🎨 Frontend</button>
                        <button class="category-tab" data-category="Backend">⚙️ Backend</button>
                        <button class="category-tab" data-category="Infra">🖥️ Infra</button>
                        <button class="category-tab" data-category="공통">📋 공통</button>
                        <button class="category-tab" data-category="QA">🧪 QA</button>
                        <button class="category-tab" data-category="보안">🔒 보안</button>
                        <button class="category-tab" data-category="기획">📝 기획</button>
                        <button class="category-tab" data-category="기타">📁 기타</button>
                        <button class="category-tab" style="background: var(--accent-primary); color: white;" onclick="refreshTemplates()">🔄 새로고침</button>
                    </div>
                </div>

                <!-- 템플릿 그리드 -->
                <div class="template-grid" id="templateGrid">
                    <!-- 템플릿 카드들이 동적으로 렌더링됨 -->
                </div>
            </section>

            <!-- Step 2: 신청서 작성 -->
            <section class="step-content" id="step2Content">
                <div class="step-header">
                    <h1 id="formTitle">📝 신청서 작성</h1>
                    <p id="formDescription">선택한 템플릿에 맞게 내용을 작성해주세요</p>
                </div>

                <div class="form-container">
                    <form id="requestForm" class="request-form">
                        <!-- 동적으로 컴포넌트들이 렌더링됨 -->
                    </form>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="goToStep(1)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5"/>
                            <polyline points="12 19 5 12 12 5"/>
                        </svg>
                        이전
                    </button>
                    <button type="button" class="btn-secondary" onclick="saveDraft()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                            <polyline points="17 21 17 13 7 13 7 21"/>
                            <polyline points="7 3 7 8 15 8"/>
                        </svg>
                        임시저장
                    </button>
                    <button type="button" class="btn-ai-validate" onclick="validateWithAI()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2a10 10 0 100 20 10 10 0 000-20z"/>
                            <path d="M12 6v6l4 2"/>
                        </svg>
                        🤖 AI 검증
                    </button>
                    <button type="button" class="btn-primary" onclick="goToStep(3)">
                        다음
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 12h14"/>
                            <polyline points="12 5 19 12 12 19"/>
                        </svg>
                    </button>
                </div>
            </section>

            <!-- Step 3: 검토 및 제출 -->
            <section class="step-content" id="step3Content">
                <div class="step-header">
                    <h1>✅ 신청서 검토</h1>
                    <p>작성한 내용을 확인하고 제출해주세요</p>
                </div>

                <div class="review-container">
                    <div class="review-summary" id="reviewSummary">
                        <!-- 작성 내용 요약이 표시됨 -->
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="goToStep(2)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5"/>
                            <polyline points="12 19 5 12 12 5"/>
                        </svg>
                        수정하기
                    </button>
                    <button type="button" class="btn-ai-validate" onclick="validateWithAI()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2a10 10 0 100 20 10 10 0 000-20z"/>
                            <path d="M12 6v6l4 2"/>
                        </svg>
                        🤖 AI 검증
                    </button>
                    <button type="button" class="btn-primary btn-submit" onclick="submitRequest()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"/>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                        </svg>
                        신청서 제출
                    </button>
                </div>
            </section>
        </main>
    </div>

    <!-- 제출 완료 모달 -->
    <div class="modal-overlay" id="submitSuccessModal">
        <div class="modal">
            <div class="modal-body success-modal">
                <div class="success-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                </div>
                <h2>🎉 신청서가 제출되었습니다!</h2>
                <p class="request-id">신청번호: <strong id="submittedRequestId"></strong></p>
                <p class="success-message">
                    신청서가 성공적으로 접수되었습니다.<br>
                    담당 부서에서 검토 후 처리할 예정이며,<br>
                    진행 상황은 대시보드에서 확인하실 수 있습니다.
                </p>
                <div class="success-info-box">
                    <div class="info-item">
                        <span class="info-icon">📋</span>
                        <span>신청서 목록에서 진행 상황 확인</span>
                    </div>
                    <div class="info-item">
                        <span class="info-icon">🔔</span>
                        <span>상태 변경 시 알림 발송</span>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn-secondary" onclick="goToDashboard()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <rect x="3" y="3" width="7" height="7"/>
                            <rect x="14" y="3" width="7" height="7"/>
                            <rect x="14" y="14" width="7" height="7"/>
                            <rect x="3" y="14" width="7" height="7"/>
                        </svg>
                        대시보드로 이동
                    </button>
                    <button class="btn-primary" onclick="createNewRequest()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        새 신청서 작성
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 토스트 알림 -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="js/auth.js"></script>
    <script src="js/auth-check.js"></script>
    <script src="js/graph-db.js"></script>
    <script src="js/templates-data.js"></script>
    <script src="js/request-form.js"></script>
    <script>
        // 전역 함수 직접 정의 (iframe 호환)
        function refreshTemplates() {
            var rawData = localStorage.getItem('formTemplates');
            alert('localStorage formTemplates:\n' + (rawData ? rawData.substring(0, 200) + '...' : 'NULL'));
            
            if (typeof loadTemplates === 'function') {
                loadTemplates();
            }
            
            var customCount = templates.filter(function(t) { return t.isCustom; }).length;
            alert('로드 결과:\n- 커스텀 템플릿: ' + customCount + '개\n- 전체 템플릿: ' + templates.length + '개');
        }
    </script>
</body>
</html>

